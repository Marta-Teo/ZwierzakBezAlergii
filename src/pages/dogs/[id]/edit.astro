---
import Layout from "../../../layouts/Layout.astro";
import { DogForm } from "../../../components/dogs/DogForm";

// Route protection
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/login?redirect=" + Astro.url.pathname);
}

const { id } = Astro.params;

// Pobranie profilu psa + opcje do selectów (SSR)
const [{ data: dogProfile, error: dogError }, { data: sizeTypes }, { data: ageCategories }, { data: allergens }] =
  await Promise.all([
    Astro.locals.supabase
      .from("dog_profiles")
      .select(
        `
      *,
      dog_allergens(allergen_id)
    `
      )
      .eq("id", id)
      .eq("user_id", user.id) // Security: tylko własne profile
      .single(),
    Astro.locals.supabase.from("size_types").select("*").order("id"),
    Astro.locals.supabase.from("age_categories").select("*").order("id"),
    Astro.locals.supabase.from("allergens").select("*").order("name"),
  ]);

// 404 jeśli pies nie istnieje lub nie należy do użytkownika
if (dogError || !dogProfile) {
  return Astro.redirect("/dogs");
}

// Transform allergens do array of IDs
const allergenIds = dogProfile.dog_allergens?.map((da: any) => da.allergen_id) || [];

const initialData = {
  id: dogProfile.id,
  name: dogProfile.name,
  size_type_id: dogProfile.size_type_id,
  age_category_id: dogProfile.age_category_id,
  allergen_ids: allergenIds,
  notes: dogProfile.notes,
};
---

<Layout title={`Edytuj ${dogProfile.name} - ZwierzakBezAlergii`}>
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">Edytuj profil: {dogProfile.name}</h1>
      <DogForm
        client:load
        mode="edit"
        initialData={initialData}
        sizeTypes={sizeTypes || []}
        ageCategories={ageCategories || []}
        allergens={allergens || []}
      />
    </div>
  </main>
</Layout>
